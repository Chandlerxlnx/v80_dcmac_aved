# Deployment Read Me 

Deploy the image via Vivado. this need Jtag cable.
UART will output the message during boot.
**Step to deploy new DCMAC test on V80**
1. compile the hw in ../hw
2. burning flash via JTAG, or burning flash via `ami_tool`
3. rescan V80 by running command `ami_tool reload -t pci -d <b>:[d].[f]`
4. check the V80 by running command `ami_tool overview`
## Burning flash via JTAG

 After the HW and FW are compiled, the PDI file which contains both PL and FW is generated in folder ../hw. Run command below to burn it into flash and boot from image.
``` bash
    make prog
    make boot
```
Or running single command for the two steps above.
```bash
   make all
```
> note: the V80 firmware and device may not be correct. need rescan pci device. cmd: `ami_tool reload -t pci -d <b>:[d].[f]`
>  *example: sudo ami_tool reload -t pci -d 09*

## Burning flash via ami_tool
if the ami_tool is installed and V80 is programmed with AVED image before, the image can be burned via `ami_tool`.
> the detail ami_tool document please refer to [AVED github io](https://xilinx.github.io/AVED/latest/index.html)
1. check the AVED cards 
 **Make sure the state of card is `READY`**
```
ami_tool overview

AMI             
-------------------------------------------------------------
Version          | 2.3.0  (0)                                
Branch          
Hash             | 0bab29e568f64a25f17425c0ffd1c0e89609b6d1  
Hash Date        | 20240307                                  
Driver Version   | 2.3.0  (0)                                


BDF       | Device         | UUID                               | AMC          | State  
----------------------------------------------------------------------------------------
09:00.0   | ALVEO V80 PQ   | 28ed90148fd07b165f289ed50bc105ab   | 2.3.0  (0)   | READY  

```
2. Burning flash
> Note the pdi file in ../hw is pdi with FPT(file partition table). need run command with `cfgmem_fpt`.

```
sudo ami_tool cfgmem_fpt -d 09:00.0 -t primary -i ../hw/dcmac_0_exdes_imp_top.pdi
[sudo] password for fintech: 
----------------------------------------------
Device | 09:00.0
----------------------------------------------
Current Configuration
----------------------------------------------
UUID   | 28ed90148fd07b165f289ed50bc105ab
----------------------------------------------
Incoming Configuration
----------------------------------------------
UUID      | N/A
Path      | ../hw/dcmac_0_exdes_imp_top.pdi
----------------------------------------------
Will update FPT!
Are you sure you wish to proceed? [Y/n]: Y

Updating FPT...

```
3. need cold reboot or fire reboot via JTAG
 * reboot via JTAG
    - make boot
    - sudo ami_tool reload -t pci -d 09:

4. check the AVED cards again
```
```

## control by host
The V80 card can be configured by `ami_tool`.
the tools and driver are compiled in **../sw**. detail compiling step please refer the **../sw/README.md**. 
After compilation, the install file will be generated in ../sw/output/<time stamp dir>/, the name started with `ami_`, it should vary depends on the OS type. My OS is ubuntu, so the file is `.deb`. install the driver and tools with corresponding command.
after installation, you can check V80 with `ami_tool`

### check V80 cards
```
ami_tool overview

AMI             
-------------------------------------------------------------
Version          | 2.3.0  (0)                                
Branch          
Hash             | 0bab29e568f64a25f17425c0ffd1c0e89609b6d1  
Hash Date        | 20240307                                  
Driver Version   | 2.3.0  (0)                                


BDF       | Device         | UUID                               | AMC          | State  
----------------------------------------------------------------------------------------
09:00.0   | ALVEO V80 PQ   | 9314f705a420bfb54815edd02dc838c2   | 2.3.0  (0)   | READY 
```


## setup the UART terminals
  Both dcmac test and AVED firmware output message during boot up. the messages are output to UART ports.
  In linux,  run minicom to connect UART ports. the device name may vary in different machine.
```bash
 konsol --new-tab -e 'minicom -b 115200 -D /dev/ttyUSB1'
 konsol --new-tab -e 'minicom -b 115200 -D /dev/ttyUSB2'
```
## monitor the UART during deployment

### output of dcmac test
> note: supposely, the dcmac can be run multiple time, when presskey r/R, it should run again. but `minicom` turn on **Hardware Flow Contrl** by default, which prevent key in. need turn it off. and turning `local echo` **on**, which echo the keys typed in screen. This is more friendly for debugging. detail refer to https://blog.csdn.net/qlexcel/article/details/111663373

```
######################################### 
# 2x100G  
######################################### 
INFO : Setting NE PCS loopback   
INFO : Waiting for GT TX Reset done... 
INFO : GT TX Reset Done achieved
INFO : Waiting for GT RX Reset done... 
INFO : GT RX Reset Done acheived
gt RX/TX reset done!  
dcmac global port reset reset done!  
Setting the DCMAC GLOBAL_MODE_REG ... 
Started MAC configuration 
Finished MAC configuration 
set_data_rate :: C0_TX_MODE_REG_REG 0x1040 50010 
set_data_rate :: C0_RX_MODE_REG_REG 0x1044 50800 
set_data_rate :: C1_TX_MODE_REG_REG 0x2040 50010 
set_data_rate :: C1_RX_MODE_REG_REG 0x2044 50800 
set_data_rate :: C2_TX_MODE_REG_REG 0x3040 50010 
set_data_rate :: C2_RX_MODE_REG_REG 0x3044 50800 
set_data_rate :: C3_TX_MODE_REG_REG 0x4040 50010 
set_data_rate :: C3_RX_MODE_REG_REG 0x4044 50800 
set_data_rate :: C4_TX_MODE_REG_REG 0x5040 50010 
set_data_rate :: C4_RX_MODE_REG_REG 0x5044 50800 
set_data_rate :: C5_TX_MODE_REG_REG 0x6040 50010 
set_data_rate :: C5_RX_MODE_REG_REG 0x6044 50800 
program dcmac done!  
release dcmac global port reset done!  
INFO : Toggle GT RXDATAPATH Reset  
INFO : Toggle DCMAC RX Reset  
INFO : Waiting for GT RX Reset done... 
INFO : GT RX Reset Done acheived
INFO : Toggle DCMAC RX Port Reset  
Waiting for active channels Alignment... 
wait_for_alignment :: C0_STAT_PORT_RX_PHY_STATUS 0x1c00 907 
Alignment achieved :: Client[0] RX achieved alignment {stat_rx_aligned, stat_rx_status} == 2'b11 
wait_for_alignment :: C1_STAT_PORT_RX_PHY_STATUS 0x2c00 907 
Alignment achieved :: Client[1] RX achieved alignment {stat_rx_aligned, stat_rx_status} == 2'b11 
Packets Start 
Packets Stop 
check_sanity::Reading gen/mon stats counters 
check_sanity::Channel[0] sent 254 core packets 
check_sanity::Channel[0] received 254 core packets 
check_sanity::Channel[0] sent 47502 total bytes 
check_sanity::Channel[0] received 47502 total bytes 
check_sanity::Channel[0] sent 254 user packets 
check_sanity::Channel[0] received 254 user packets 
check_sanity::Channel[0] sent 46486 total bytes 
check_sanity::Channel[0] received 46486 total bytes  
check_sanity::Channel[1] sent 251 core packets 
check_sanity::Channel[1] received 251 core packets 
check_sanity::Channel[1] sent 47444 total bytes 
check_sanity::Channel[1] received 47444 total bytes 
check_sanity::Channel[1] sent 251 user packets 
check_sanity::Channel[1] received 251 user packets 
check_sanity::Channel[1] sent 46440 total bytes 
check_sanity::Channel[1] received 46440 total bytes  

PORT - 0 Statistics           

  STAT_TX_TOTAL_PACKETS           = 0,           STAT_RX_TOTAL_PACKETS           = 254

  STAT_TX_TOTAL_GOOD_PACKETS      = -2147483648,         STAT_RX_TOTAL_GOOD_PACKETS      = 254

  STAT_TX_TOTAL_BYTES             = -2147483648,         STAT_RX_BYTES                   = 47502

  STAT_TX_TOTAL_GOOD_BYTES        = -32768,              STAT_RX_TOTAL_GOOD_BYTES        = 47502


PORT - 1 Statistics           

  STAT_TX_TOTAL_PACKETS           = 0,           STAT_RX_TOTAL_PACKETS           = 251

  STAT_TX_TOTAL_GOOD_PACKETS      = -2147483648,         STAT_RX_TOTAL_GOOD_PACKETS      = 251

  STAT_TX_TOTAL_BYTES             = -2147483648,         STAT_RX_BYTES                   = 47444

  STAT_TX_TOTAL_GOOD_BYTES        = -32768,              STAT_RX_TOTAL_GOOD_BYTES        = 47444

INFO : stat_match_flag 3 
INFO : Test Completed Successfully and Passed  

*******Test Completed        
 rerun dcmac test: press r/R 
quit dcmac test: press q/Q
```


### AVED Firmware output
```
[AMC] PLL initialised OK
[AMC] EVL initialised OK
[AMC] Core Libs initialised OK
[I2C] Device Configured: 0 0xff020000 100000
[I2C] Device Configured: 1 0xff030000 100000
[AMC] I2C driver Initialised OK
[AMC] iEEPROM_Initialised OK
[EEPROM] Manufacturing INFO: EEPROM Version        : 4.0
[EEPROM] Manufacturing INFO: Name                  : ALVEO V80 PQ
[EEPROM] Manufacturing INFO: Board Rev             : 1
[EEPROM] Manufacturing INFO: Serial Number         : XFL13JRIRIPQ
[EEPROM] Manufacturing INFO: # MACS                : 16
[EEPROM] Manufacturing INFO: Mac Address 1         : 00:0a:35:22:4b:c0
[EEPROM] Manufacturing INFO: MFG DATE              : 30f7e6
[EEPROM] Manufacturing INFO: Board Part Num        : A-V80-P64G-PQ-G
[EEPROM] Manufacturing INFO: UUID                  : c758d915-e70a-db8f-5c4b-f2f45502e8d7
[EEPROM] Manufacturing INFO: MFG part number       : 043-05113-01
[AMC] SysMon Driver Initialised OK
[AMC] Device drivers Initialised OK
[PROFILE_FAL] PCIe SMBus link enabled
[PROFILE_FAL] GCQ service: starting
[PROFILE_FAL] GCQ service: ready
[PROFILE_FAL] OSPI driver: starting
[OSPI] FlashID:0x2C 0x5B 0x1C 0x10 0x41 0x00 0xD2 0x68 0x00 
[OSPI] FCT Index:2, page size:256, sector size:32768
[PROFILE_FAL] OSPI driver: ready
[FW_IF_SMBUS_BLOCK_IO] SMBus SW version: 1.2.0
[FW_IF_SMBUS_BLOCK_IO] SMBus IP version: 1.1
[AMC] FAL Initialised OK
[AMC] APC Proxy Driver initialised and bound
[AMC] AXC Proxy Driver initialised and bound
[AMC] ASC Proxy Driver initialised
[AMC] AMI Proxy Driver initialised and bound
[AMC] BMC Proxy Driver initialised and bound
[AMC] Proxy Drivers Initialised OK
[AMC] In-band service: ready
[AMC] Out-of-band service: ready
[AMC] Built in Monitoring (BIM) application started
[AMC] Apps Initialised OK
[AMC] Debug initialised
[AMC] ullAmcInitStatus:
[AMC] ucPllInitialised                TRUE
[AMC] ucEvlInitialised                TRUE
[AMC] ucI2cInitialised                TRUE
[AMC] ucEepromInitialised             TRUE
[AMC] ucSysmonInitialised             TRUE
[AMC] ucSmbusPcieLinkInitialised      TRUE
[AMC] ucMuxedDeviceFalInitialised     TRUE
[AMC] ucGcqFalInitialised             TRUE
[AMC] ucEmmcFalInitialised            TRUE
[AMC] ucOspiFalInitialised            TRUE
[AMC] ucSmbusFalInitialised           TRUE
[AMC] ucMuxedDeviceFalCreated         TRUE
[AMC] ucGcqFalCreated                 TRUE
[AMC] ucEmmcFalCreated                TRUE
[AMC] ucOspiFalCreated                TRUE
[AMC] ucSmbusFalCreated               TRUE
[AMC] ucApcInitialised                TRUE
[AMC] ucAxcInitialised                TRUE
[AMC] ucAscInitialised                TRUE
[AMC] ucAmiInitialised                TRUE
[AMC] ucBmcInitialised                TRUE
[AMC] ucAsdmInitialised               TRUE
[AMC] ucInBandInitialised             TRUE
[AMC] ucOutOfBandInitialised          TRUE
[BIM] Event QSFP 3 NOT PRESENT [ 0x00010300 ]
[BIM] Event QSFP 2 NOT PRESENT [ 0x00010200 ]
[BIM] Event QSFP 1 PRESENT [ 0x00000100 ]
[BIM] Event QSFP 0 PRESENT [ 0x00000000 ]

###############################################################
#                                                             #
#                             AMC                             #
#                                                             #
# Copyright (c) 2024 Advanced Micro Devices, Inc.             #
# All rights reserved.                                        #
#                                                             #
# SPDX-License-Identifier: MIT                                #
#                                                             #
###############################################################
[AMC] AMC: 2.3.0-0.37139f6.20240725 
[AMC] OS:  freeRTOS v10.6.1

```

### output during flash programming
```
...
...
[2075.016] 0.077 ms for Partition#: 0x9, Size: 1984 Bytes
[2080.063]---Loading Partition#: 0xA, Id: 0x0
[2084.349] 0.200 ms for Partition#: 0xA, Size: 74368 Bytes
[2089.432]***********Boot PDI Load: Done***********
```

## error during ami_tool cfgmem_fpt
the error below disapeared somehow when the temperature decreased.
```
sudo ami_tool cfgmem_fpt -d 09:00.0 -t primary -i ../hw/dcmac_0_exdes_imp_top.pdi 
[sudo] password for fintech: 
----------------------------------------------
Device | 09:00.0
----------------------------------------------
Current Configuration
----------------------------------------------
UUID   | 28ed90148fd07b165f289ed50bc105ab
----------------------------------------------
Incoming Configuration
----------------------------------------------
UUID      | N/A
Path      | ../hw/dcmac_0_exdes_imp_top.pdi
----------------------------------------------
Will update FPT!
Are you sure you wish to proceed? [Y/n]: Y

Updating FPT...
[....................................................................................................] 0% |[....................................................................................................] 1% -[#...................................................................................................] 1% |[#...................................................................................................] 1% -[#...................................................................................................] 2% |[##..................................................................................................] 2% -[##..................................................................................................] 2% |[##..................................................................................................] 3% -[###.................................................................................................] 3% |[###.................................................................................................] 3% -[###.................................................................................................] 4% |[####................................................................................................] 4% -[####................................................................................................] 4% |[####................................................................................................] 5% -[#####...............................................................................................] 5% |[#####...............................................................................................] 5% -[#####...............................................................................................] 6% |[######..............................................................................................] 6% -[######..............................................................................................] 7% |[######..............................................................................................] 7% -[#######.............................................................................................] 7% |[#######.............................................................................................] 8% -[#######.............................................................................................] 8% |[########............................................................................................] 8% -[########............................................................................................] 9% |[########............................................................................................] 9% -[#########...........................................................................................] 9% |[#########...........................................................................................] 10% [#########...........................................................................................] 10% [##########..........................................................................................] 10% [##########..........................................................................................] 11% [##########..........................................................................................] 11% [###########.........................................................................................] 11% [###########.........................................................................................] 12% [###########.........................................................................................] 12% [############........................................................................................] 12% [############........................................................................................] 13% [#############.......................................................................................] 13% [#############.......................................................................................] 13% [#############.......................................................................................] 14% [##############......................................................................................] 14% [##############......................................................................................] 14% [##############......................................................................................] 15% [###############.....................................................................................] 15% [###############.....................................................................................] 15% [###############.....................................................................................] 16% [################....................................................................................] 16% [################....................................................................................] 16% [################....................................................................................] 17% [#################...................................................................................] 17% [#################...................................................................................] 17% [#################...................................................................................] 18% [##################..................................................................................] 18% [##################..................................................................................] 18% [##################..................................................................................] 19% [###################.................................................................................] 19% [###################.................................................................................] 20% [###################.................................................................................] 20% [####################................................................................................] 20% [####################................................................................................] 21% [####################................................................................................] 21% [#####################...............................................................................] 21% [#####################...............................................................................] 22% [#####################...............................................................................] 22% [######################..............................................................................] 22% [######################..............................................................................] 23% [######################..............................................................................] 23% [#######################.............................................................................] 23% [#######################.............................................................................] 24% [#######################.............................................................................] 24% [########################............................................................................] 24% [########################............................................................................] 25% [########################............................................................................] 25% [#########################...........................................................................] 25% [#########################...........................................................................] 26% [##########################..........................................................................] 26% [##########################..........................................................................] 26% [##########################..........................................................................] 27% [###########################.........................................................................] 27% [###########################.........................................................................] 27% [###########################.........................................................................] 28% [############################........................................................................] 28% [############################........................................................................] 28% [############################........................................................................] 29% [#############################.......................................................................] 29% [#############################.......................................................................] 29% [#############################.......................................................................] 30% [##############################......................................................................] 30% [##############################......................................................................] 30% [##############################......................................................................] 31% [###############################.....................................................................] 31% [###############################.....................................................................] 31% [###############################.....................................................................] 32% [################################....................................................................] 32% [################################....................................................................] 33% [################################....................................................................] 33% [#################################...................................................................] 33% [#################################...................................................................] 34% [#################################...................................................................] 34% [##################################..................................................................] 34% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% [##################################..................................................................] 35% | Error: could not program image
EIO: File could not be read or written [do_image_download:149 - errno 110 (Connection timed out)].
fintech@fintech-u:~/github/V80/v80_ethernet/aved_pfm_dcmac/deploy$ sudo ami_tool cfgmem_fpt -d 09:00.0 -t primary -i ../hw/dcmac_0_exdes_imp_top.pdi 
----------------------------------------------
Device | 09:00.0
----------------------------------------------
Current Configuration
----------------------------------------------
UUID   | 28ed90148fd07b165f289ed50bc105ab
----------------------------------------------
Incoming Configuration
----------------------------------------------
UUID      | N/A
Path      | ../hw/dcmac_0_exdes_imp_top.pdi
----------------------------------------------
Will update FPT!
Are you sure you wish to proceed? [Y/n]: Y

Updating FPT...
[....................................................................................................] 0% | Error: could not program image
EIO: File could not be read or written [do_image_download:149 - errno 1 (Operation not permitted)].
fintech@fintech-u:~/github/V80/v80_ethernet/aved_pfm_dcmac/deploy$ ami_tool overview

AMI             
-------------------------------------------------------------
Version          | 2.3.0  (0)                                
Branch          
Hash             | 0bab29e568f64a25f17425c0ffd1c0e89609b6d1  
Hash Date        | 20240307                                  
Driver Version   | 2.3.0  (0)                                


BDF       | Device         | UUID                               | AMC          | State   
-----------------------------------------------------------------------------------------
09:00.0   | ALVEO V80 PQ   | 28ed90148fd07b165f289ed50bc105ab   | 2.3.0  (0)   | NO_AMC  

```
